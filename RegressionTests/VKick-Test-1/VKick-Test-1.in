Option, ECHO=FALSE;
Option, INFO=FALSE;
Option, AUTOPHASE=0;
Option, VERSION=10900;

Title, string="HKick Test";


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// GLOBAL PARAMETERS
//
// Here we define some global simulation parameters.

REAL RF_FREQUENCY = 700.0e6;			     // Reference frequency of problem (Hz).
REAL RF_WAVELENGTH = CLIGHT / RF_FREQUENCY; 	     // Reference wavelength (m).

REAL Q_E = 1.60217653e-19;  	 		     // Elementary charge (C).
REAL E_MASS = 9.10938188e-31;		     // Mass of electron (kg).


REAL BEAM_BUNCH_CHARGE = 0.0e-15;     // Beam bunch charge (C).
REAL NUMBER_OF_PARTICLES = 10000; // Number of particles in simulation

REAL PS_DUMP_FREQUENCY = 100000;     // How often (time steps) that the phase space of the beam is output.
REAL STAT_DUMP_FREQUENCY = 10; // How often (time steps) beam statistical properties are output.

value, {RF_FREQUENCY,
        RF_WAVELENGTH,
        BEAM_BUNCH_CHARGE,
	NUMBER_OF_PARTICLES,
	PS_DUMP_FREQUENCY,
	STAT_DUMP_FREQUENCY};

//============================================
// Timestep information.
//================================================

// Time steps defined.
//\\\\\\\\\\\\\\\\\\\\

REAL TIME_STEP_1 = 2.0 * 1.0e-12;   // Time step (s). We only need one for this simulation.

value, {TIME_STEP_1};

//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// FIELD SOLVERS
//
// Here we define the field solvers (FS) to be used in the simulation.

// First define the space charge (SC) mesh.

// Space charge mesh.
REAL FS_SC1_X_BINS = 8; // Number of mesh bins in x direction for space charge field solver.
REAL FS_SC1_Y_BINS = 8; // Number of mesh bins in y direction for space charge field solver.
REAL FS_SC1_Z_BINS = 8; // Number of mesh bins in z direction for space charge field solver.

value, {FS_SC1_X_BINS,
        FS_SC1_Y_BINS,
	FS_SC1_Z_BINS};


//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// BEAM LINE
//
// Here we define lengths, positions, phases, field multipliers/strengths etc. for the various components of the
// accelerator.

// Beam line offset. This is global shift of the entire line (m).
//===============================================================
REAL global_shift = 1.0;


// Kick.
//
// We have one kick in the system.
//================================

// Drift before kick (m).
REAL drift_before_kick = 0.25;

// Drift after kick (m).
REAL drift_after_kick = 0.5;

// Kick angle (degrees).
REAL kick_angle = 3.0;

// Kick length (m).
REAL kick_length = 0.1;

value, {drift_before_kick,
        drift_after_kick,
        kick_angle,
	kick_length};

//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// DEFINE FIELD SOLVERS
//
// Here we define field solvers (FS) using the parameters defined in the layout section.

// First space charge field solver.

FS_SC1: Fieldsolver, FSTYPE = NONE, MX = FS_SC1_X_BINS, MY = FS_SC1_Y_BINS, MT = FS_SC1_Z_BINS,
		     PARFFTX = false, PARFFTY = false, PARFFTT = true,
		     BCFFTX = open, BCFFTY = open, BCFFTT = open,
		     BBOXINCR = 2, GREENSF = INTEGRATED;


//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// COMPONENTS
//
// Here we define the actual accelerator components using the parameters from the layout section.
//******************************************************************************************************************


// Begin: Kick ///////////////////////////////////////////////////////////////////////////////////////////////////
//
// Definition of kicker Kick.
//

//
// L:			physical element length (real in m)
// KICK:                kick angle (rad)
// ELEMEDGE:	     	physical start of the element on the floor (real in m)
//

kick1: VKICKER, KICK = kick_angle * Pi / 180.0,
	        ELEMEDGE = global_shift + drift_before_kick,
	        L = kick_length;


// Calculate position of end of Kick.
REAL kick_end = global_shift + drift_before_kick + kick_length + drift_after_kick;

value, {kick_end};

// End: Kick ///////////////////////////////////////////////////////////////////////////////////////////////////


//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// DEFINE BEAM LINES
//
// Here we define beam lines using previously defined elements.

Beamline: Line = (kick1);


//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// INITIAL DISTRIBUTIONS
//
// Initial beam distribution.
//

Initial_Distribution: DISTRIBUTION, TYPE = FROMFILE,
			 	    FNAME = "VKick-Test-1.dat";


/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//******************************************************************************************************************
//******************************************************************************************************************
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//******************************************************************************************************************
//******************************************************************************************************************
// RUN SIMULATION
//
// Here we start simulation.

REAL MINSTEPFORREBIN = 750;

Option, PSDUMPFREQ = PS_DUMP_FREQUENCY;
Option, STATDUMPFREQ = STAT_DUMP_FREQUENCY;


//\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
// Here we define beam that will be transported.
//\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
beam_1: BEAM, PARTICLE = ELECTRON,
	      pc = P0,
	      NPART = NUMBER_OF_PARTICLES,
	      BFREQ = RF_FREQUENCY * 1e-6,
      	      BCURRENT = BEAM_BUNCH_CHARGE * RF_FREQUENCY,
	      CHARGE = -1;


//\\\\\\\\\\\\\\\\
// Run simulation.
//\\\\\\\\\\\\\\\\

TRACK, LINE = Beamline,
       BEAM = beam_1,
       MAXSTEPS = 1000000,
       DT = TIME_STEP_1,
       ZSTART = 1.0,
       ZSTOP = kick_end;

RUN, METHOD = "PARALLEL-T",
     BEAM = beam_1,
     FIELDSOLVER = FS_SC1,
     DISTRIBUTION = Initial_Distribution;

ENDTRACK;

Stop;
Quit;
